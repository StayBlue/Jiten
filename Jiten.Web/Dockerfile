FROM node:23-alpine AS build
WORKDIR /app

RUN corepack enable && corepack prepare pnpm@latest --activate

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY patches/ patches/
RUN pnpm install --frozen-lockfile

COPY . .

ARG NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_WEBSITE_ID
ARG NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_HOST_URL
ARG NUXT_PUBLIC_BASE_URL
ARG NUXT_PUBLIC_GOOGLE_SIGNIN_CLIENT_ID
ARG NUXT_PUBLIC_RECAPTCHA_V2_SITE_KEY

ENV NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_WEBSITE_ID=$NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_WEBSITE_ID
ENV NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_HOST_URL=$NUXT_PUBLIC_SCRIPTS_UMAMI_ANALYTICS_HOST_URL
ENV NUXT_PUBLIC_BASE_URL=$NUXT_PUBLIC_BASE_URL
ENV NUXT_PUBLIC_GOOGLE_SIGNIN_CLIENT_ID=$NUXT_PUBLIC_GOOGLE_SIGNIN_CLIENT_ID
ENV NUXT_PUBLIC_RECAPTCHA_V2_SITE_KEY=$NUXT_PUBLIC_RECAPTCHA_V2_SITE_KEY
ENV NUXT_TELEMETRY_DISABLED=1

RUN pnpm build

FROM node:23-alpine AS final
WORKDIR /app
COPY --from=build /app/.output ./
ENV NUXT_HOST=0.0.0.0
ENV NUXT_PORT=3001
ENV PORT=3001
EXPOSE 3001
CMD ["node", "--max-old-space-size=1536", "server/index.mjs"]
